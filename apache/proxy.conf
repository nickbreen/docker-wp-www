<VirtualHost *:80>
  ServerName proxy
  DocumentRoot /var/www

  # Normalise Cookie: remove known noisy cookies: Google Analytics.
  RequestHeader edit* Cookie "__utm.=.*?(?:$|;\s*)" ""
  # Unset the header if we've no cookies left.
  RequestHeader unset Cookie "expr=-z %{req:Cookie}"

  # Cart: Vary on the cart hash
  SetEnvIf Cookie woocommerce_cart_hash=([[:xdigit:]]+) WOOCOMMERCE_CART_HASH=$1
  RequestHeader set X-Woocommerce-Cart-Hash none env=!WOOCOMMERCE_CART_HASH
  RequestHeader set X-Woocommerce-Cart-Hash %{WOOCOMMERCE_CART_HASH}e env=WOOCOMMERCE_CART_HASH

  # Session, Vary on the session's customer ID
  SetEnvIf Cookie wp_woocommerce_session_(?:[[:xdigit:]]+)=([[:xdigit:]]+) WOOCOMMERCE_SESSION_CUSTOMER=$1
  RequestHeader set X-Woocommerce-Session-Customer anonymous env=!WOOCOMMERCE_SESSION_CUSTOMER
  RequestHeader set X-Woocommerce-Session-Customer %{WOOCOMMERCE_SESSION_CUSTOMER}e env=WOOCOMMERCE_SESSION_CUSTOMER

  ProxyPreserveHost On
  DirectoryIndex disabled
  DirectorySlash off
  Options -Indexes

  <Directory /var/www/wp-content/uploads/>
    RemoveHandler .php
    RedirectMatch 404 "\.php"
    RewriteEngine off
  </Directory>

  <Location ~ "^/status-(apache|fpm)$">
    AuthType basic
    AuthName Stats
    AuthBasicProvider file
    AuthUserFile /etc/htpasswd
    Require user stats
  </Location>

  <Location "/status-apache">
    SetHandler server-status
  </Location>

  AddHandler "proxy:http://127.0.0.2" .php

  # REQUEST_URI         The path part of the request's URI
  # REQUEST_FILENAME    The full local filesystem path to the file or script matching the request, if this has already
  #                     been determined by the server at the time REQUEST_FILENAME is referenced. Otherwise, such as
  #                     when used in virtual host context, the same value as REQUEST_URI
  RewriteEngine on
  RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
  RewriteRule .* http://127.0.0.2$0 [P,QSA]

  # Remove the Vary headers used by the cache, don't forget to remove the commas too.
  Header edit* Vary X-Woocommerce-(?:Cart-Hash|Session-Customer),? ""
  Header edit* Vary X-Forwarded-Proto,? ""

  # Unset the Vary header if it's empty.
  Header unset Vary "expr=-z %{resp:Vary}"

  # Output some interesting performance stats.
  Header always set X-Performance "%D %t %l %i %b"

  Header add X-Server proxy
</VirtualHost>
