<VirtualHost *:80>
  ServerName proxy
  DocumentRoot /var/www

  # Normalise Cookie: remove known noisy cookies: Google Analytics.
  RequestHeader edit* Cookie "__utm.=.*?(?:$|;\s*)" ""
  # Unset the header if we've no cookies left.
  RequestHeader unset Cookie "expr=-z %{req:Cookie}"

  # Cart: Vary on the cart hash
  SetEnvIf Cookie woocommerce_cart_hash=([[:xdigit:]]+) WOOCOMMERCE_CART_HASH=$1
  RequestHeader set X-Woocommerce-Cart-Hash none env=!WOOCOMMERCE_CART_HASH
  RequestHeader set X-Woocommerce-Cart-Hash %{WOOCOMMERCE_CART_HASH}e env=WOOCOMMERCE_CART_HASH

  # Session, Vary on the session's customer ID
  SetEnvIf Cookie wp_woocommerce_session_(?:[[:xdigit:]]+)=([[:xdigit:]]+) WOOCOMMERCE_SESSION_CUSTOMER=$1
  RequestHeader set X-Woocommerce-Session-Customer anonymous env=!WOOCOMMERCE_SESSION_CUSTOMER
  RequestHeader set X-Woocommerce-Session-Customer %{WOOCOMMERCE_SESSION_CUSTOMER}e env=WOOCOMMERCE_SESSION_CUSTOMER

  ProxyPreserveHost On

  AddHandler "proxy:http://127.0.0.2" .php
  <If "!-f %{REQUEST_FILENAME}">
    SetHandler "proxy:http://127.0.0.2"
  </If>

  <Directory /var/www/wp-content/uploads/>
    RedirectMatch 404 "\.php"
  </Directory>

  <Location ~ "^/status-(apache|fpm)$">
    AuthType basic
    AuthName Stats
    AuthBasicProvider file
    AuthUserFile /etc/htpasswd
    Require user stats
  </Location>

  <Location "/status-apache">
    SetHandler server-status
  </Location>

  # Remove the Vary headers used by the cache, don't forget to remove the commas too.
  Header edit* Vary X-Woocommerce-(?:Cart-Hash|Session-Customer),? ""
  Header edit* Vary X-Forwarded-Proto,? ""
  #Header edit* Vary Cookie,? ""

  # Unset the Vary header if it's empty.
  Header unset Vary "expr=-z %{resp:Vary}"

  # Output some interesting performance stats.
  Header always set X-Performance "%D %t %l %i %b"

  # For any file on disk, assume a distant expiry date.
  # The cache requires an Expires/Cache-Control header for files when requested
  # with a query string (like WordPress does for versioned CSS/JS files).
  ExpiresActive On
  ExpiresDefault "modifcation plus 1 year"
</VirtualHost>
