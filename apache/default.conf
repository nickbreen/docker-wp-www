<VirtualHost *:80>
    ServerName www
    DocumentRoot /var/www

    # Normalise Cookie: remove known noisy cookies: Google Analytics.
    RequestHeader edit* Cookie "__utm.=.*?(?:$|;\s*)" ""
    # Unset the header if we've no cookies left.
    RequestHeader unset Cookie "expr=-z %{req:Cookie}"

    ProxyPreserveHost On
    DirectoryIndex disabled
    DirectoryIndex index.php
    DirectorySlash on
    Options -Indexes

    <Directory /var/www/wp-content/uploads/>
        RemoveHandler .php
    	FallbackResource disabled
        RedirectMatch 404 "\.php"
        Options -Indexes
    </Directory>

    <Location ~ "^/status-(apache|fpm)$">
        AuthType basic
        AuthName Stats
        AuthBasicProvider file
        AuthUserFile /etc/htpasswd
        Require user stats
    </Location>

    <Location "/status-apache">
        CacheDisable on
        SetHandler server-status
    </Location>

    CacheDetailHeader On
    CacheEnable disk /
    CacheHeader On
    CacheIgnoreHeaders Set-Cookie
    CacheIgnoreNoLastMod On # Use CacheDefaultExpire (defaults to one hour)
    CacheLock On
    CacheStoreExpired On
    CacheQuickHandler Off

    # https://httpd.apache.org/docs/2.4/mod/mod_dir.html#fallbackresource
    # This is the contemporary way to hand requests off to PHP/WP/whatever
    #FallbackResource /index.php
    # Except it and mod_cache do not play nicely together (and mod_cache caches everything as the fallback url)
    # So, we're back to mod_rewrite...
    RewriteEngine On
    # Existing actual files are not cached, except for /index.php
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} -f
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} -d
    RewriteCond %{REQUEST_FILENAME} !=/index.php
    RewriteRule ^.*$ - [E=no-cache,E=no-log]
    # If there's no actual file then 'forward' via /index.php
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-f
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_FILENAME} !-d
    RewriteRule ^.*$ /index.php$0 [QSA,E=!no-cache]

    AddHandler "proxy:fcgi://fastcgi:9000" .php
    <Location ~ "^/(ping|status)-fpm$">
        CacheDisable on
        SetHandler "proxy:fcgi://fastcgi:9000"
    </Location>

    ExpiresActive On
    ExpiresDefault "access plus 5 minutes"

    # Vary on the protocol, as we use this header to punk is_ssl in wordpress.
    Header merge Vary X-Forwarded-Proto

    # Output some interesting performance stats.
    Header always set X-Performance "%D %t %l %i %b"

    SetEnvIf Request_URI "^/(favicon.ico|robots.txt)$" no-log
    CustomLog "|/usr/bin/logger --tag apache --stderr" "%t %R %V %m %U %q %s %D %B \"%{X-Forwarded-For}i\"" env=!no-log
</VirtualHost>
