<VirtualHost *:80>
    ServerName www
    DocumentRoot /var/www

    LogLevel cache:trace2 cache_socache:trace2 socache_memcache:trace2 socache_shmcb:trace2

    # TODO make this do the opposite: keep only known cookies.
    # Normalise Cookie: remove known noisy cookies: Google Analytics.
    RequestHeader edit* Cookie "__utm.=.*?(?:$|;\s*)" ""
    # Unset the header if we've no cookies left.
    RequestHeader unset Cookie "expr=-z %{req:Cookie}"

    ProxyPreserveHost On

    AddHandler "proxy:fcgi://fastcgi:9000" .php
    # AddType application/php .php
    # AddOutputFilterByType CACHE application/php

    # CacheSocache memcache:memcache:11211
    CacheDetailHeader On
    CacheHeader On
    CacheIgnoreHeaders Set-Cookie
    # Use CacheDefaultExpire (defaults to one hour)
    CacheIgnoreNoLastMod On 
    CacheLock On
    CacheStoreExpired On
    CacheStoreNoStore On
    CacheQuickHandler Off
    # CacheEnable socache /
    CacheEnable disk /

    # https://httpd.apache.org/docs/2.4/mod/mod_dir.html#fallbackresource
    # This is the contemporary way to hand requests off to PHP/WP/whatever
    # FallbackResource /index.php
    # Except it and mod_cache (CacheQuickHandler off) do not play nicely together (and mod_cache caches everything as the fallback url)
    # So, we're back to mod_rewrite...
    RewriteEngine On

    <Location />
        DirectoryIndex disabled
        DirectoryIndex index.php
        DirectorySlash on
        Options -Indexes

        # For .php 
        RewriteCond %{REQUEST_FILENAME} ^.+\.php$
        # If it doesn't exist, bail.
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule / - [E=!no-cache,E=!no-log,F]
        # Otherwise don't try anything else 
        RewriteCond %{REQUEST_FILENAME} ^.+\.php$
        RewriteRule / - [E=!no-cache,E=!no-log,L]

        # Existing actual files are not cached nor rewritten
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        # Neither are our special URL's
        RewriteCond %{REQUEST_URI} =/ping-fpm [OR]
        RewriteCond %{REQUEST_URI} =/status-fpm [OR]
        RewriteCond %{REQUEST_URI} =/status-apache
        RewriteRule / - [E=no-cache,E=no-log,L]

        # If we get to here then there's no real file and it's not PHP
        # So, unless it is a dir, rewrite it
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule / /index.php%{REQUEST_URI} [QSA,E=!no-cache,E=!no-log,L]
    </Location>

    <Directory /var/www/wp-content/uploads/>
        RemoveHandler .php
        # FallbackResource disabled
        DirectoryIndex disabled
        RedirectMatch 404 "\.php"
        Options -Indexes
    </Directory>

    <Location /wp-content/uploads/>
        RewriteCond %{ENV:UPLOADS_REDIR_BASE} !=""
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule / %{ENV:UPLOADS_REDIR_BASE}%{REQUEST_URI} [QSA,E=!no-cache,R=permanent,L]
    </Location>

    <Location ~ ^/status-(apache|fpm)$>
        CacheDisable on
        AuthType basic
        AuthName Stats
        AuthBasicProvider file
        AuthUserFile /etc/htpasswd
        Require user stats
    </Location>

    <Location ~ ^/(ping|status)-fpm$>
        CacheDisable on
        SetHandler "proxy:fcgi://fastcgi:9000"
    </Location>

    <Location /status-apache>
        CacheDisable on
        SetHandler server-status
    </Location>

    ExpiresActive On
    
    # Output some interesting performance stats.
    Header always set X-Performance "%D %t %l %i %b"

    SetEnvIf Request_URI "^/(favicon.ico|robots.txt|sitemap.xml)$" no-log
</VirtualHost>
