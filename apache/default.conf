<VirtualHost *:80>
    ServerName www
    DocumentRoot /var/www

    # TODO make this do the opposite: keep only known cookies.
    # Normalise Cookie: remove known noisy cookies: Google Analytics.
    RequestHeader edit* Cookie "__utm.=.*?(?:$|;\s*)" ""
    # Unset the header if we've no cookies left.
    RequestHeader unset Cookie "expr=-z %{req:Cookie}"

    ProxyPreserveHost On

    AddHandler "proxy:fcgi://fastcgi:9000" .php

    CacheDetailHeader On
    CacheEnable disk /
    CacheHeader On
    CacheIgnoreHeaders Set-Cookie
    CacheIgnoreNoLastMod On # Use CacheDefaultExpire (defaults to one hour)
    CacheLock On
    CacheStoreExpired On
    CacheQuickHandler Off

    # https://httpd.apache.org/docs/2.4/mod/mod_dir.html#fallbackresource
    # This is the contemporary way to hand requests off to PHP/WP/whatever
    #FallbackResource /index.php
    # Except it and mod_cache do not play nicely together (and mod_cache caches everything as the fallback url)
    # So, we're back to mod_rewrite...
    RewriteEngine On

    <Location />
        DirectoryIndex disabled
        DirectoryIndex index.php
        DirectorySlash on
        Options -Indexes

        # Existing actual files are not cached, except for /index.php
        RewriteCond %{REQUEST_URI} !=/index.php
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule / - [E=no-cache,E=no-log,L]

        # If there's no actual file then 'forward' via /index.php
        # Mark the X-Forwarded-Proto header for Vary
        RewriteCond %{HTTP:X-Forwarded-Proto} "https?"
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !=/ping-fpm
        RewriteCond %{REQUEST_URI} !=/status-fpm

        RewriteRule / /index.php%{REQUEST_URI} [QSA,E=!no-cache]
    </Location>

    <Directory /var/www/wp-content/uploads/>
        RemoveHandler .php
        #FallbackResource disabled
        DirectoryIndex disabled
        RedirectMatch 404 "\.php"
        Options -Indexes
    </Directory>

    <Location /wp-content/uploads/>
        RewriteCond %{ENV:UPLOADS_REDIR_BASE} !=""
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule / %{ENV:UPLOADS_REDIR_BASE}%{REQUEST_URI} [QSA,E=!no-cache,R=permanent,L]
    </Location>

    <Location ~ ^/status-(apache|fpm)$>
        AuthType basic
        AuthName Stats
        AuthBasicProvider file
        AuthUserFile /etc/htpasswd
        Require user stats
    </Location>

    <Location ~ ^/(ping|status)-fpm$>
        CacheDisable on
        SetHandler "proxy:fcgi://fastcgi:9000"
    </Location>

    <Location /status-apache>
        CacheDisable on
        SetHandler server-status
    </Location>

    ExpiresActive On
    ExpiresDefault "modified plus 1 years"

    # Output some interesting performance stats.
    Header always set X-Performance "%D %t %l %i %b"

    SetEnvIf Request_URI "^/(favicon.ico|robots.txt)$" no-log
    CustomLog "|/usr/bin/logger --tag apache --stderr" "%t %R %V %m %U %q %s %D %B \"%{X-Forwarded-For}i\"" env=!no-log
</VirtualHost>
